<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çocuk Acil Nöbetmatik</title>
    
    <!-- React ve ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSX'i tarayıcıda çalıştırmak için) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .cell-input { width: 100%; height: 100%; text-align: center; background: transparent; outline: none; }
        .print-container { width: 100%; font-family: 'Arial', sans-serif; background-color: white; }
        
        /* Fade in animasyonu */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Scrollbar düzenlemesi */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const DEFAULT_STAFF = [
            "BUSE KORKMAZ", "BÜŞRA ERKAN", "BİLAL ŞEKERCİ", "CAN PAKER",
            "EMİNE SARI", "EMİNE HANIM YILDIZ", "ELİF NUR DUMLUPINAR", "ESRA ÇETİN",
            "HACER ALTANAY CAN", "KIYMET KARAKIŞ", "MEHMET NESİM SATILMIŞ", "MELTEM SUNTAY",
            "MEVLÜDE ÇOBAN", "NUR FATMA GÖK", "NAZMİYE İNAL DÖNMEZ", "NURCAN YILMAZ",
            "ÖZNUR TANGUR", "CAHİDE AKIN"
        ];

        const SHIFTS_PER_DAY = 6;
        const MAX_CONSECUTIVE_GAP_SHIFTS = 5; 
        const MONTH_NAMES = ["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];

        // --- Yeni Personel Kartı Bileşeni ---
        const StaffItem = ({ name, onSave, onDelete }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [tempName, setTempName] = useState(name);

            useEffect(() => {
                setTempName(name);
            }, [name]);

            const handleSave = () => {
                if (tempName.trim()) {
                    onSave(tempName.toUpperCase());
                    setIsEditing(false);
                }
            };

            const handleCancel = () => {
                setTempName(name);
                setIsEditing(false);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') handleSave();
                if (e.key === 'Escape') handleCancel();
            };

            if (isEditing) {
                return (
                    <div className="flex items-center space-x-1 bg-blue-50 p-1 rounded shadow-md border border-blue-200 transform scale-105 transition z-10 h-8">
                        <input 
                            type="text" 
                            value={tempName} 
                            onChange={(e) => setTempName(e.target.value)}
                            onKeyDown={handleKeyDown}
                            className="flex-1 p-0.5 border border-blue-300 rounded text-xs uppercase focus:outline-none focus:ring-1 focus:ring-blue-400 w-full"
                            autoFocus
                            placeholder="İSİM"
                        />
                        <button onClick={handleSave} className="bg-green-500 text-white w-5 h-5 rounded flex items-center justify-center hover:bg-green-600 transition shadow-sm" title="Kaydet">
                            <i className="fas fa-check text-[10px]"></i>
                        </button>
                        <button onClick={handleCancel} className="bg-gray-300 text-gray-600 w-5 h-5 rounded flex items-center justify-center hover:bg-gray-400 transition shadow-sm" title="İptal">
                            <i className="fas fa-times text-[10px]"></i>
                        </button>
                    </div>
                );
            }

            return (
                <div className="flex items-center space-x-1 bg-white border border-gray-200 p-1 rounded hover:bg-blue-50 hover:border-blue-200 hover:shadow-sm transition group h-8">
                    <div className="flex-1 flex items-center cursor-pointer min-w-0" onClick={() => setIsEditing(true)} title="Düzenlemek için tıklayın">
                        <div className="w-5 h-5 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 mr-1.5 flex-shrink-0 group-hover:bg-blue-100 group-hover:text-blue-500">
                            <i className="fas fa-user text-[10px]"></i>
                        </div>
                        <span className="text-xs font-medium text-gray-700 truncate select-none">{name}</span>
                    </div>
                    <div className="flex space-x-0.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <button onClick={() => setIsEditing(true)} className="text-blue-400 hover:text-blue-600 p-1 rounded hover:bg-blue-100" title="Düzenle">
                            <i className="fas fa-pen text-[10px]"></i>
                        </button>
                        <button onClick={onDelete} className="text-red-400 hover:text-red-600 p-1 rounded hover:bg-red-100" title="Sil">
                            <i className="fas fa-trash text-[10px]"></i>
                        </button>
                    </div>
                </div>
            );
        };

        function App() {
            const [staff, setStaff] = useState(DEFAULT_STAFF);
            
            // Formdaki (Yeni oluşturulacak) tarih seçimleri
            const [inputYear, setInputYear] = useState(2026);
            const [inputMonth, setInputMonth] = useState(1); // Şubat

            // Hafızadaki (Yüklü/Oluşturulmuş) listenin "gerçek" tarihi
            const [loadedDate, setLoadedDate] = useState(null); 
            
            // TÜM KAYITLI PROJELER (LocalStorage'dan gelir)
            const [savedProjects, setSavedProjects] = useState([]);
            
            // Silme onayı için hangi projenin seçildiğini tutan state
            const [projectToDelete, setProjectToDelete] = useState(null);

            const [daysInMonth, setDaysInMonth] = useState(28);
            const [constraints, setConstraints] = useState({}); 
            const [schedule, setSchedule] = useState({}); 
            const [stats, setStats] = useState({});
            const [activeTab, setActiveTab] = useState('settings'); 
            const [showClearConfirm, setShowClearConfirm] = useState(false); 
            const tableRef = useRef(null);
            const fileInputRef = useRef(null);

            // LocalStorage'dan projeleri çek
            useEffect(() => {
                const localData = localStorage.getItem('nobet_projects');
                if (localData) {
                    try {
                        const parsed = JSON.parse(localData);
                        parsed.sort((a, b) => {
                            if (b.year !== a.year) return b.year - a.year;
                            return b.month - a.month;
                        });
                        setSavedProjects(parsed);
                    } catch (e) {
                        console.error("Kayıt okuma hatası", e);
                    }
                }
            }, []);

            // Formdaki Ay/Yıl değişince gün sayısını güncelle
            useEffect(() => {
                const days = new Date(inputYear, inputMonth + 1, 0).getDate();
                setDaysInMonth(days);
            }, [inputYear, inputMonth]);

            // İstatistikleri her schedule değişiminde güncelle
            useEffect(() => {
                calculateStats(schedule);
            }, [schedule, staff]); 

            // --- LocalStorage Yardımcıları ---
            const saveToLocal = (data) => {
                const id = `${data.year}-${data.month}`; 
                const newProject = { 
                    ...data, 
                    id, 
                    timestamp: new Date().toISOString() 
                };

                setSavedProjects(prev => {
                    const others = prev.filter(p => p.id !== id);
                    const newList = [newProject, ...others].sort((a, b) => {
                        if (b.year !== a.year) return b.year - a.year;
                        return b.month - a.month;
                    });
                    localStorage.setItem('nobet_projects', JSON.stringify(newList));
                    return newList;
                });
            };

            const handleDeleteClick = (e, id) => {
                e.stopPropagation();
                setProjectToDelete(id);
            };

            const confirmDeleteProject = (e, id) => {
                e.stopPropagation();
                setSavedProjects(prev => {
                    const newList = prev.filter(p => p.id !== id);
                    localStorage.setItem('nobet_projects', JSON.stringify(newList));
                    return newList;
                });
                if (loadedDate && `${loadedDate.year}-${loadedDate.month}` === id) {
                    setLoadedDate(null);
                    setSchedule({});
                    setConstraints({});
                    setActiveTab('settings');
                }
                setProjectToDelete(null);
            };

            const cancelDeleteProject = (e) => {
                e.stopPropagation();
                setProjectToDelete(null);
            };

            const loadFromSaved = (project) => {
                setStaff(project.staff);
                setConstraints(project.constraints || {});
                setSchedule(project.schedule || {});
                setLoadedDate({ month: project.month, year: project.year });
                
                setInputMonth(project.month);
                setInputYear(project.year);
                setDaysInMonth(project.daysInMonth || new Date(project.year, project.month + 1, 0).getDate());

                setActiveTab('result');
            };

            // --- Diğer Fonksiyonlar ---
            const getDaysArray = () => Array.from({ length: daysInMonth }, (_, i) => i + 1);
            
            const getResultDaysArray = () => {
                if (!loadedDate) return getDaysArray();
                const days = new Date(loadedDate.year, loadedDate.month + 1, 0).getDate();
                return Array.from({ length: days }, (_, i) => i + 1);
            };

            const toggleConstraint = (person, day) => {
                const key = `${person}_${day}`;
                const current = constraints[key];
                const newConstraints = { ...constraints };

                if (!current) newConstraints[key] = 'X';      
                else if (current === 'X') newConstraints[key] = 'İ'; 
                else if (current === 'İ') newConstraints[key] = 'N'; 
                else delete newConstraints[key];

                setConstraints(newConstraints);
            };

            const clearConstraints = () => {
                setConstraints({});
                setShowClearConfirm(false);
            };

            const calculateStats = (currentSchedule) => {
                const currentDays = loadedDate 
                    ? new Date(loadedDate.year, loadedDate.month + 1, 0).getDate()
                    : daysInMonth;

                const newStats = {};
                staff.forEach(person => {
                    let totalHours = 0;
                    let shifts = 0;
                    let gapViolations = 0;
                    let lastShiftDay = -10;

                    for (let day = 1; day <= currentDays; day++) {
                        const key = `${person}_${day}`;
                        if (currentSchedule[key] === '24') {
                            shifts++;
                            totalHours += 24;
                            if (day - lastShiftDay === 2) {
                                gapViolations++;
                            }
                            lastShiftDay = day;
                        }
                    }
                    newStats[person] = { shifts, totalHours, gapViolations };
                });
                setStats(newStats);
            };

            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            const generateSchedule = () => {
                const targetYear = inputYear;
                const targetMonth = inputMonth;
                const targetDays = daysInMonth;

                const newSchedule = { ...constraints };
                let tempSchedule = {}; 
                
                for (let day = 1; day <= targetDays; day++) {
                    tempSchedule[day] = [];
                    staff.forEach(person => {
                        const key = `${person}_${day}`;
                        if (constraints[key] === 'N') {
                            newSchedule[key] = '24';
                            tempSchedule[day].push(person);
                        }
                    });
                }

                let nurseState = {};
                staff.forEach(p => {
                    nurseState[p] = {
                        shiftCount: 0,
                        lastShiftDay: -10,
                        gapViolations: 0
                    };
                    for(let d=1; d<=targetDays; d++){
                         if(newSchedule[`${p}_${d}`] === '24') {
                             nurseState[p].shiftCount++;
                             if(d - nurseState[p].lastShiftDay === 2) nurseState[p].gapViolations++;
                             nurseState[p].lastShiftDay = d;
                         }
                    }
                });

                for (let day = 1; day <= targetDays; day++) {
                    let assignedToday = [...tempSchedule[day]];
                    
                    if (assignedToday.length >= SHIFTS_PER_DAY) continue;

                    let candidates = staff.filter(person => {
                        if (assignedToday.includes(person)) return false;
                        const constraint = constraints[`${person}_${day}`];
                        if (constraint === 'X' || constraint === 'İ') return false;
                        if (newSchedule[`${person}_${day-1}`] === '24') return false;
                        if (constraints[`${person}_${day+1}`] === 'N') return false;
                        return true;
                    });

                    candidates = shuffleArray(candidates);

                    candidates.sort((a, b) => {
                        const stateA = nurseState[a];
                        const stateB = nurseState[b];

                        if (stateA.shiftCount !== stateB.shiftCount) {
                            return stateA.shiftCount - stateB.shiftCount;
                        }

                        const willViolateGapA = (day - stateA.lastShiftDay === 2);
                        const willViolateGapB = (day - stateB.lastShiftDay === 2);
                        const scoreA = (willViolateGapA && stateA.gapViolations >= MAX_CONSECUTIVE_GAP_SHIFTS) ? 1000 : 0;
                        const scoreB = (willViolateGapB && stateB.gapViolations >= MAX_CONSECUTIVE_GAP_SHIFTS) ? 1000 : 0;

                        if (scoreA !== scoreB) return scoreA - scoreB;
                        return (stateA.lastShiftDay - stateB.lastShiftDay); 
                    });

                    const needed = SHIFTS_PER_DAY - assignedToday.length;
                    
                    for (let i = 0; i < needed; i++) {
                        if (candidates[i]) {
                            const p = candidates[i];
                            newSchedule[`${p}_${day}`] = '24';
                            assignedToday.push(p);
                            nurseState[p].shiftCount++;
                            if (day - nurseState[p].lastShiftDay === 2) {
                                nurseState[p].gapViolations++;
                            }
                            nurseState[p].lastShiftDay = day;
                        }
                    }
                }

                staff.forEach(person => {
                   for (let day = 1; day <= targetDays; day++) {
                       const key = `${person}_${day}`;
                       if (constraints[key] === 'İ') {
                           newSchedule[key] = 'İ';
                       }
                   } 
                });

                setSchedule(newSchedule);
                setLoadedDate({ month: targetMonth, year: targetYear });
                
                saveToLocal({
                    staff,
                    year: targetYear,
                    month: targetMonth,
                    daysInMonth: targetDays,
                    constraints,
                    schedule: newSchedule
                });
                
                setActiveTab('result');
            };

            const saveProject = () => {
                const saveYear = loadedDate ? loadedDate.year : inputYear;
                const saveMonth = loadedDate ? loadedDate.month : inputMonth;
                const saveDays = loadedDate ? new Date(saveYear, saveMonth + 1, 0).getDate() : daysInMonth;

                const projectData = {
                    version: "1.0",
                    date: new Date().toISOString(),
                    staff,
                    year: saveYear,
                    month: saveMonth,
                    daysInMonth: saveDays,
                    constraints,
                    schedule
                };
                
                const now = new Date();
                const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}.${String(now.getMinutes()).padStart(2, '0')}`;
                const fileName = `Cocuk Acil ${dateStr}.json`;

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", fileName);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const loadProject = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.staff) setStaff(data.staff);
                        if (data.year && data.month !== undefined) {
                            setLoadedDate({ month: data.month, year: data.year });
                            setInputMonth(data.month);
                            setInputYear(data.year);
                        }
                        if (data.daysInMonth) setDaysInMonth(data.daysInMonth);
                        if (data.constraints) setConstraints(data.constraints);
                        if (data.schedule) {
                            setSchedule(data.schedule);
                        }
                        
                        saveToLocal(data);
                        alert("Proje başarıyla yüklendi!");
                    } catch (error) {
                        console.error("Dosya okuma hatası:", error);
                        alert("Dosya formatı hatalı veya bozuk.");
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const downloadImage = () => {
                if (tableRef.current && window.html2canvas) {
                    const originalTable = tableRef.current.querySelector('.print-container');
                    if (!originalTable) return;

                    const clone = originalTable.cloneNode(true);
                    const targetWidth = 1400; 
                    
                    clone.style.position = 'fixed';
                    clone.style.top = '-10000px';
                    clone.style.left = '0';
                    clone.style.width = `${targetWidth}px`; 
                    clone.style.zIndex = '-1000';
                    clone.style.backgroundColor = '#ffffff';
                    clone.style.padding = '20px'; 

                    const originalInputs = originalTable.querySelectorAll('input');
                    const clonedInputs = clone.querySelectorAll('input');
                    originalInputs.forEach((origInput, index) => {
                        const clonedInput = clonedInputs[index];
                        if (clonedInput) {
                            const div = document.createElement('div');
                            div.innerText = origInput.value;
                            div.className = origInput.className;
                            div.style.display = 'flex';
                            div.style.alignItems = 'center';
                            div.style.justifyContent = 'center';
                            div.style.width = '100%';
                            div.style.height = '100%';
                            div.style.backgroundColor = 'transparent';
                            if (clonedInput.parentNode) clonedInput.parentNode.replaceChild(div, clonedInput);
                        }
                    });

                    clone.querySelectorAll('.sticky').forEach(el => {
                        el.style.position = 'static';
                    });

                    document.body.appendChild(clone);

                    window.html2canvas(clone, {
                        scale: 2, 
                        backgroundColor: "#ffffff",
                        useCORS: true,
                        width: targetWidth,
                        height: clone.scrollHeight + 50 
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Cocuk_Acil_Nobet_Listesi_${loadedDate ? loadedDate.month+1 : inputMonth+1}_${loadedDate ? loadedDate.year : inputYear}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.95);
                        link.click();
                        document.body.removeChild(clone);
                    });
                }
            };

            const handleStaffUpdate = (index, newName) => {
                const newStaff = [...staff];
                newStaff[index] = newName.toUpperCase();
                setStaff(newStaff);
            };

            const addStaff = () => setStaff([...staff, "YENİ PERSONEL"]);
            const removeStaff = (index) => {
                const newStaff = staff.filter((_, i) => i !== index);
                setStaff(newStaff);
            };
            const getCellColor = (val) => {
                if (val === '24') return 'bg-white text-black font-bold'; 
                if (val === 'N') return 'bg-blue-100 text-blue-800 font-bold';
                if (val === 'X') return 'bg-gray-100 text-red-500 font-bold';
                if (val === 'İ') return 'bg-gray-50 text-gray-500 font-bold';
                return 'hover:bg-gray-50';
            };

            // --- Sayfalar ---
            const SettingsPanel = () => (
                <div className="bg-white p-6 rounded-lg shadow-md mb-6 animate-fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-start mb-6 gap-4">
                        <div>
                            <h2 className="text-xl font-bold text-gray-700 flex items-center">
                                <i className="fas fa-home mr-2"></i> Ana Menü
                            </h2>
                            <p className="text-sm text-gray-500 mt-1">Nöbet programı oluşturun veya kayıtlı verileri yönetin.</p>
                        </div>
                        <div className="flex space-x-2">
                            <input 
                                type="file" 
                                accept=".json" 
                                ref={fileInputRef} 
                                style={{display:'none'}} 
                                onChange={loadProject} 
                            />
                            <button onClick={() => fileInputRef.current.click()} className="bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 shadow flex items-center transition">
                                <i className="fas fa-upload mr-2"></i> Veri Yükle (JSON)
                            </button>
                            {schedule && Object.keys(schedule).length > 0 && loadedDate && (
                                <button onClick={saveProject} className="bg-orange-500 text-white py-2 px-4 rounded hover:bg-orange-600 shadow flex items-center transition">
                                    <i className="fas fa-save mr-2"></i> Veri Kaydet (JSON)
                                </button>
                            )}
                        </div>
                    </div>

                    {/* KAYITLI PROJELER LİSTESİ */}
                    {savedProjects.length > 0 && (
                        <div className="mb-8 p-6 bg-slate-50 border border-slate-200 rounded-xl shadow-sm animate-fade-in">
                            <h3 className="font-bold text-gray-700 mb-4 flex items-center">
                                <i className="fas fa-folder-open mr-2 text-yellow-500"></i> Kayıtlı Dönemler
                            </h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                {savedProjects.map((proj) => (
                                    <div key={proj.id} className="relative group">
                                        <button 
                                            onClick={() => loadFromSaved(proj)}
                                            className="w-full bg-white border border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-blue-300 transition text-left"
                                        >
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-bold text-lg text-gray-800">
                                                    {MONTH_NAMES[proj.month]} {proj.year}
                                                </span>
                                                <i className="fas fa-chevron-right text-gray-400 group-hover:text-blue-500"></i>
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                <span className="inline-block bg-blue-100 text-blue-800 px-2 py-0.5 rounded mr-2">
                                                    {new Date(proj.timestamp).toLocaleDateString("tr-TR")}
                                                </span>
                                                {proj.staff ? proj.staff.length : 0} Personel
                                            </div>
                                        </button>
                                        
                                        {/* Çöp Kutusu Butonu */}
                                        {projectToDelete !== proj.id && (
                                            <button 
                                                onClick={(e) => handleDeleteClick(e, proj.id)}
                                                className="absolute top-2 right-2 bg-red-100 text-red-500 w-8 h-8 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition hover:bg-red-200 z-10 shadow-sm"
                                                title="Bu kaydı sil"
                                            >
                                                <i className="fas fa-trash-alt text-xs"></i>
                                            </button>
                                        )}

                                        {/* Silme Onay Kutucuğu */}
                                        {projectToDelete === proj.id && (
                                            <div className="absolute top-2 right-2 bg-white border border-gray-200 p-3 shadow-xl rounded-lg z-20 flex flex-col items-end animate-fade-in" onClick={(e) => e.stopPropagation()}>
                                                <p className="text-xs text-gray-700 font-bold mb-2 whitespace-nowrap">Silinsin mi?</p>
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={cancelDeleteProject} 
                                                        className="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300"
                                                    >
                                                        İptal
                                                    </button>
                                                    <button 
                                                        onClick={(e) => confirmDeleteProject(e, proj.id)} 
                                                        className="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"
                                                    >
                                                        Evet
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Yıl</label>
                            <input type="number" value={inputYear} onChange={(e)=>setInputYear(parseInt(e.target.value))} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Ay</label>
                            <select value={inputMonth} onChange={(e)=>setInputMonth(parseInt(e.target.value))} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                {MONTH_NAMES.map((m,i)=>(
                                    <option key={i} value={i}>{m}</option>
                                ))}
                            </select>
                        </div>
                        <div className="flex items-end">
                             <button onClick={() => setActiveTab('constraints')} className="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition shadow flex items-center justify-center">
                                <i className="fas fa-magic mr-2"></i> Yeni Liste Oluştur
                             </button>
                        </div>
                    </div>

                    <div className="border-t pt-4">
                        <h3 className="font-semibold mb-3 text-gray-600 flex items-center justify-between">
                            <span>Personel Listesi ({staff.length} Kişi)</span>
                            <span className="text-xs text-gray-400 font-normal">Düzenlemek için isme tıklayın</span>
                        </h3>
                        {/* max-h sınırını kaldırdım ve grid kolon sayısını artırdım */}
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 pr-1 custom-scroll">
                            {staff.map((p, i) => (
                                <StaffItem 
                                    key={i} 
                                    name={p} 
                                    onSave={(newName) => handleStaffUpdate(i, newName)}
                                    onDelete={() => removeStaff(i)}
                                />
                            ))}
                        </div>
                        <button onClick={addStaff} className="mt-3 w-full md:w-auto bg-green-50 text-green-700 py-2 px-4 rounded border border-green-200 hover:bg-green-100 hover:border-green-300 transition font-semibold flex items-center justify-center">
                            <i className="fas fa-user-plus mr-2"></i> Personel Ekle
                        </button>
                    </div>
                </div>
            );

            const ConstraintGrid = () => (
                <div className="bg-white p-4 rounded-lg shadow-md mb-6 overflow-hidden animate-fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                         <button onClick={() => setActiveTab('settings')} className="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 shadow flex items-center transition">
                            <i className="fas fa-arrow-left mr-2"></i> Ana Menü
                         </button>
                         <div className="flex flex-wrap items-center gap-3">
                            <div className="flex space-x-2 text-xs md:text-sm bg-gray-50 p-2 rounded">
                                <span className="flex items-center"><span className="w-3 h-3 bg-red-100 border border-red-200 mr-1"></span> X: İstemiyor</span>
                                <span className="flex items-center"><span className="w-3 h-3 bg-gray-100 border border-gray-300 mr-1"></span> İ: İzinli</span>
                                <span className="flex items-center"><span className="w-3 h-3 bg-blue-200 border border-blue-300 mr-1"></span> N: Kesin Nöbet</span>
                            </div>
                            <div className="relative">
                                <button 
                                    onClick={() => setShowClearConfirm(true)} 
                                    className="bg-red-100 text-red-600 py-2 px-3 rounded hover:bg-red-200 text-sm border border-red-200 flex items-center transition"
                                >
                                    <i className="fas fa-trash-alt mr-1"></i> Temizle
                                </button>
                                {showClearConfirm && (
                                    <div className="absolute top-full right-0 mt-2 bg-white border border-gray-200 p-3 shadow-xl rounded-lg z-50 w-48 animate-fade-in">
                                        <p className="text-xs text-gray-700 mb-3 font-semibold text-center">Tüm işaretler silinsin mi?</p>
                                        <div className="flex justify-center gap-2">
                                            <button onClick={() => setShowClearConfirm(false)} className="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded transition">İptal</button>
                                            <button onClick={clearConstraints} className="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition">Evet, Sil</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="mb-4">
                         <h2 className="text-xl font-bold text-gray-700 text-center">Kısıtlamalar: {MONTH_NAMES[inputMonth]} {inputYear}</h2>
                         <p className="text-center text-sm text-gray-500">Personelin nöbet tutamayacağı veya kesin tutacağı günleri seçin.</p>
                    </div>
                    
                    <div className="overflow-x-auto">
                        <table className="min-w-full text-xs border-collapse border border-gray-300">
                            <thead>
                                <tr className="bg-gray-100">
                                    <th className="p-2 min-w-[150px] text-left sticky left-0 bg-gray-100 z-10 shadow-sm border border-gray-300">Personel</th>
                                    {getDaysArray().map(d => (
                                        <th key={d} className="p-1 w-8 text-center border border-gray-300">{d}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {staff.map(person => (
                                    <tr key={person}>
                                        <td className="p-2 font-medium sticky left-0 bg-white z-10 border border-gray-300 shadow-sm whitespace-nowrap">{person}</td>
                                        {getDaysArray().map(d => {
                                            const val = constraints[`${person}_${d}`];
                                            return (
                                                <td 
                                                    key={d} 
                                                    className={`cursor-pointer select-none transition-colors border border-gray-300 ${getCellColor(val)}`}
                                                    onClick={() => toggleConstraint(person, d)}
                                                >
                                                    <div className="w-full h-8 flex items-center justify-center">
                                                        {val || ''}
                                                    </div>
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    <div className="mt-6 flex justify-end">
                         <button onClick={generateSchedule} className="bg-teal-600 text-white py-2 px-6 rounded font-bold hover:bg-teal-700 shadow-lg transform transition hover:scale-105 flex items-center">
                            <i className="fas fa-magic mr-2"></i> LİSTEYİ OLUŞTUR
                         </button>
                    </div>
                </div>
            );

            const ResultView = () => (
                <div className="animate-fade-in">
                    <style>{`
                        .cell-input { width: 100%; height: 100%; text-align: center; background: transparent; outline: none; }
                        .print-container { width: 100%; font-family: 'Arial', sans-serif; background-color: white; }
                    `}</style>

                    <div className="bg-white p-4 rounded-lg shadow-md mb-6">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setActiveTab('settings')} className="bg-gray-600 text-white py-2 px-3 rounded hover:bg-gray-700 text-sm shadow flex items-center transition">
                                    <i className="fas fa-home mr-2"></i> Ana Menü
                                </button>
                                <h2 className="text-2xl font-bold text-teal-800">Nöbet Listesi</h2>
                            </div>
                            <div className="flex space-x-2">
                                <button onClick={() => setActiveTab('constraints')} className="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600 text-sm shadow transition">
                                    <i className="fas fa-edit"></i> Düzenle
                                </button>
                                <button onClick={generateSchedule} className="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm shadow transition flex items-center">
                                     <i className="fas fa-sync-alt mr-2"></i> Tekrar Dağıt
                                </button>
                                <button onClick={downloadImage} className="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 font-bold text-sm shadow transform active:scale-95 transition">
                                    <i className="fas fa-download"></i> JPG İNDİR
                                </button>
                            </div>
                        </div>

                        <div className="overflow-x-auto border rounded-lg bg-white" ref={tableRef}>
                            <div className="print-container p-8 min-w-[1000px]">
                                <div className="text-center mb-8">
                                    <h1 className="text-2xl font-bold uppercase tracking-wide text-black">ÇOCUK ACİL SERVİS NÖBET ÇİZELGESİ</h1>
                                    <h3 className="text-lg text-gray-600 uppercase mt-2">
                                        {loadedDate ? MONTH_NAMES[loadedDate.month] : MONTH_NAMES[inputMonth]} {loadedDate ? loadedDate.year : inputYear}
                                    </h3>
                                </div>

                                <table className="w-full text-xs border-collapse border border-gray-400 text-black">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            <th className="p-3 w-48 text-left border border-gray-400 font-bold text-black">PERSONEL ADI SOYADI</th>
                                            {getResultDaysArray().map(d => (
                                                <th key={d} className="p-1 w-8 text-center border border-gray-400 font-bold text-black">{d}</th>
                                            ))}
                                            <th className="p-1 w-12 text-center border border-gray-400 bg-gray-200 text-black">Nöbet</th>
                                            <th className="p-1 w-12 text-center border border-gray-400 bg-gray-200 text-black">Saat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {staff.map((person, idx) => {
                                            const personStats = stats[person] || {shifts:0, totalHours:0};
                                            return (
                                                <tr key={person} className="bg-white">
                                                    <td className="p-2 font-semibold border border-gray-400 whitespace-nowrap text-black">{person}</td>
                                                    {getResultDaysArray().map(d => {
                                                        const key = `${person}_${d}`;
                                                        const val = schedule[key];
                                                        let displayVal = "";
                                                        let textColor = "text-gray-300";
                                                        
                                                        if (val === '24') { displayVal = "24"; textColor = "text-black font-bold"; }
                                                        else if (val === 'İ') { displayVal = "İ"; textColor = "text-red-600 font-bold"; }
                                                        else if (val === 'X') { displayVal = "X"; textColor = "text-gray-400"; }

                                                        return (
                                                            <td key={d} className="p-0 border border-gray-400 text-center relative h-8">
                                                                <input 
                                                                    className={`cell-input ${textColor}`}
                                                                    value={displayVal}
                                                                    onChange={(e) => {
                                                                        const newVal = e.target.value.toUpperCase();
                                                                        let safeVal = newVal;
                                                                        if(newVal === 'I' || newVal === 'İ') safeVal = 'İ';
                                                                        
                                                                        const newSched = {...schedule, [key]: safeVal};
                                                                        setSchedule(newSched);
                                                                        calculateStats(newSched);
                                                                        
                                                                        if(loadedDate) {
                                                                            saveToLocal({
                                                                                staff,
                                                                                year: loadedDate.year,
                                                                                month: loadedDate.month,
                                                                                daysInMonth: daysInMonth,
                                                                                constraints,
                                                                                schedule: newSched
                                                                            });
                                                                        }
                                                                    }}
                                                                />
                                                            </td>
                                                        );
                                                    })}
                                                    <td className="text-center font-bold bg-gray-100 text-black border border-gray-400">{personStats.shifts}</td>
                                                    <td className="text-center font-bold bg-gray-100 text-black border border-gray-400">{personStats.totalHours}</td>
                                                </tr>
                                            );
                                        })}
                                        {/* Toplam Satırı */}
                                        <tr className="bg-gray-200 font-bold text-black">
                                            <td className="p-2 text-right border border-gray-400">GÜNLÜK TOPLAM:</td>
                                            {getResultDaysArray().map(d => {
                                                let count = 0;
                                                staff.forEach(p => {
                                                    if(schedule[`${p}_${d}`] === '24') count++;
                                                });
                                                return (
                                                    <td key={d} className={`text-center p-1 border border-gray-400 ${count !== 6 ? 'text-red-600' : 'text-green-900'}`}>
                                                        {count}
                                                    </td>
                                                )
                                            })}
                                            <td colSpan="2" className="border border-gray-400"></td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div className="flex justify-end mt-4">
                                    <div className="border border-gray-400 p-2 text-xs text-black bg-white inline-block">
                                        <div className="font-bold border-b border-gray-300 mb-1 pb-1">AÇIKLAMALAR</div>
                                        <div className="flex items-center mb-1"><span className="w-4 font-bold text-center mr-1">24</span> : 24 Saat Nöbet</div>
                                        <div className="flex items-center mb-1"><span className="w-4 font-bold text-center mr-1 text-red-600">İ</span> : İzinli / Yıllık İzin</div>
                                        <div className="flex items-center mb-1"><span className="w-4 font-bold text-center mr-1 text-blue-800">N</span> : Kesin Nöbet (İstek)</div>
                                        <div className="flex items-center"><span className="w-4 font-bold text-center mr-1 text-gray-400">X</span> : Nöbet İstemiyor</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-8 font-sans bg-gray-50 min-h-screen">
                    <header className="flex items-center justify-center mb-8">
                        <div className="bg-teal-600 text-white p-4 rounded-full shadow-lg mr-4">
                            <i className="fas fa-user-nurse fa-2x"></i>
                        </div>
                        <div>
                            <h1 className="text-3xl font-bold text-gray-800">Nöbetmatik v1.1</h1>
                            <p className="text-gray-500">Çocuk Acil Servis Otomasyonu</p>
                        </div>
                    </header>

                    {activeTab === 'settings' && <SettingsPanel />}
                    {activeTab === 'constraints' && <ConstraintGrid />}
                    {activeTab === 'result' && <ResultView />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>