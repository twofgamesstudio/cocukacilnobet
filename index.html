<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çocuk Acil Nöbetmatik</title>
    
    <!-- React ve ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .cell-input { width: 100%; height: 100%; text-align: center; background: transparent; outline: none; }
        
        /* Yazıcı Dostu Konteyner */
        .print-container { 
            width: 100%; 
            font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background-color: white;
            color: #1f2937;
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Gelişmiş Tablo Stilleri */
        .th-cell { 
            font-size: 11px; 
            padding: 4px 2px; 
            border: 1px solid #64748b; 
            text-align: center; 
            font-weight: 800; 
        }
        .td-cell { 
            border: 1px solid #94a3b8; 
            font-size: 11px; 
            height: 34px; 
            font-weight: 600;
        }
        
        /* Renk Paleti */
        .header-bg { background-color: #0f766e; color: white; } 
        .weekend-bg { background-color: #ffedd5; } 
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Varsayılan listeyi Türkçe kurallara göre sıralı başlat
        const DEFAULT_STAFF = [
            "BİLAL ŞEKERCİ", "BUSE KORKMAZ", "BÜŞRA ERKAN", "CAHİDE AKIN",
            "CAN PAKER", "ELİF NUR DUMLUPINAR", "EMİNE HANIM YILDIZ", "EMİNE SARI", 
            "ESRA ÇETİN", "HACER ALTANAY CAN", "KIYMET KARAKIŞ", "MEHMET NESİM SATILMIŞ", 
            "MELTEM SUNTAY", "MEVLÜDE ÇOBAN", "NAZMİYE İNAL DÖNMEZ", "NUR FATMA GÖK", 
            "NURCAN YILMAZ", "ÖZNUR TANGUR"
        ].sort((a, b) => a.localeCompare(b, 'tr'));

        const SHIFTS_PER_DAY = 6;
        const MAX_CONSECUTIVE_GAP_SHIFTS = 5; 
        const MONTH_NAMES = ["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];
        const DAY_INITIALS = ["P", "P", "S", "Ç", "P", "C", "C"]; 

        const currentYear = new Date().getFullYear();
        const YEAR_OPTIONS = Array.from({length: 15}, (_, i) => currentYear - 2 + i);

        // --- Personel Kartı ---
        const StaffItem = ({ name, onSave, onDelete }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [tempName, setTempName] = useState(name);

            useEffect(() => { setTempName(name); }, [name]);

            const handleSave = () => {
                if (tempName.trim()) {
                    onSave(name, tempName.toUpperCase()); 
                    setIsEditing(false);
                }
            };

            const handleCancel = () => {
                setTempName(name);
                setIsEditing(false);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') handleSave();
                if (e.key === 'Escape') handleCancel();
            };

            if (isEditing) {
                return (
                    <div className="flex items-center space-x-1 bg-teal-50 p-1 rounded shadow-md border border-teal-300 transform scale-105 transition z-10 h-9 ring-2 ring-teal-200">
                        <input 
                            type="text" 
                            value={tempName} 
                            onChange={(e) => setTempName(e.target.value)}
                            onKeyDown={handleKeyDown}
                            className="flex-1 p-1 border border-teal-300 rounded text-xs uppercase focus:outline-none w-full font-bold text-teal-800"
                            autoFocus
                            placeholder="İSİM"
                        />
                        <button onClick={handleSave} className="bg-green-500 text-white w-6 h-6 rounded flex items-center justify-center hover:bg-green-600 transition shadow-sm"><i className="fas fa-check text-[10px]"></i></button>
                        <button onClick={handleCancel} className="bg-gray-400 text-white w-6 h-6 rounded flex items-center justify-center hover:bg-gray-500 transition shadow-sm"><i className="fas fa-times text-[10px]"></i></button>
                    </div>
                );
            }

            return (
                <div className="flex items-center space-x-2 bg-white border border-gray-200 p-1.5 rounded hover:bg-teal-50 hover:border-teal-300 hover:shadow-md transition group h-9 cursor-pointer" onClick={() => setIsEditing(true)}>
                    <div className="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 mr-1 flex-shrink-0 group-hover:bg-teal-100 group-hover:text-teal-600">
                        <i className="fas fa-user text-xs"></i>
                    </div>
                    <span className="text-xs font-bold text-gray-700 truncate select-none flex-1">{name}</span>
                    <div className="flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <button onClick={(e) => { e.stopPropagation(); setIsEditing(true); }} className="text-blue-500 hover:text-blue-700 p-1 rounded hover:bg-blue-100"><i className="fas fa-pen text-[10px]"></i></button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(name); }} className="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-100"><i className="fas fa-trash text-[10px]"></i></button>
                    </div>
                </div>
            );
        };

        function App() {
            const [staff, setStaff] = useState(DEFAULT_STAFF);
            const [inputYear, setInputYear] = useState(2026);
            const [inputMonth, setInputMonth] = useState(1);
            const [loadedDate, setLoadedDate] = useState(null); 
            const [savedProjects, setSavedProjects] = useState([]);
            const [projectToDelete, setProjectToDelete] = useState(null);
            const [daysInMonth, setDaysInMonth] = useState(28);
            const [constraints, setConstraints] = useState({}); 
            const [schedule, setSchedule] = useState({}); 
            const [stats, setStats] = useState({});
            const [activeTab, setActiveTab] = useState('settings'); 
            const [showClearConfirm, setShowClearConfirm] = useState(false); 
            const tableRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const localData = localStorage.getItem('nobet_projects');
                if (localData) {
                    try {
                        const parsed = JSON.parse(localData);
                        parsed.sort((a, b) => {
                            if (b.year !== a.year) return b.year - a.year;
                            return b.month - a.month;
                        });
                        setSavedProjects(parsed);
                    } catch (e) { console.error(e); }
                }
            }, []);

            useEffect(() => {
                const days = new Date(inputYear, inputMonth + 1, 0).getDate();
                setDaysInMonth(days);
            }, [inputYear, inputMonth]);

            useEffect(() => {
                calculateStats(schedule);
            }, [schedule, staff]); 

            // --- Yardımcılar ---
            const isWeekend = (year, month, day) => {
                const d = new Date(year, month, day);
                const dayIdx = d.getDay();
                return dayIdx === 0 || dayIdx === 6;
            };

            const getDayNameInitial = (year, month, day) => {
                const d = new Date(year, month, day);
                return DAY_INITIALS[d.getDay()];
            };

            const saveToLocal = (data) => {
                const id = `${data.year}-${data.month}`; 
                const calculatedStats = {}; 
                data.staff.forEach(p => {
                    let s = 0;
                    if(data.schedule) {
                        for(let d=1; d<=data.daysInMonth; d++) {
                            if(data.schedule[`${p}_${d}`] === '24') s++;
                        }
                    }
                    calculatedStats[p] = { shifts: s };
                });
                const newProject = { ...data, id, timestamp: new Date().toISOString(), stats: calculatedStats };
                setSavedProjects(prev => {
                    const others = prev.filter(p => p.id !== id);
                    const newList = [newProject, ...others].sort((a, b) => {
                        if (b.year !== a.year) return b.year - a.year;
                        return b.month - a.month;
                    });
                    localStorage.setItem('nobet_projects', JSON.stringify(newList));
                    return newList;
                });
            };

            const handleDeleteClick = (e, id) => { e.stopPropagation(); setProjectToDelete(id); };
            const cancelDeleteProject = (e) => { e.stopPropagation(); setProjectToDelete(null); };
            const confirmDeleteProject = (e, id) => {
                e.stopPropagation();
                setSavedProjects(prev => {
                    const newList = prev.filter(p => p.id !== id);
                    localStorage.setItem('nobet_projects', JSON.stringify(newList));
                    return newList;
                });
                if (loadedDate && `${loadedDate.year}-${loadedDate.month}` === id) {
                    setLoadedDate(null); setSchedule({}); setConstraints({}); setActiveTab('settings');
                }
                setProjectToDelete(null);
            };

            const loadFromSaved = (project) => {
                // Yüklerken Türkçe karakterlere göre sırala
                setStaff(project.staff.sort((a, b) => a.localeCompare(b, 'tr')));
                setConstraints(project.constraints || {});
                setSchedule(project.schedule || {});
                setLoadedDate({ month: project.month, year: project.year });
                setInputMonth(project.month);
                setInputYear(project.year);
                setDaysInMonth(project.daysInMonth || new Date(project.year, project.month + 1, 0).getDate());
                setActiveTab('result');
            };

            const getDaysArray = () => Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const getResultDaysArray = () => {
                if (!loadedDate) return getDaysArray();
                const days = new Date(loadedDate.year, loadedDate.month + 1, 0).getDate();
                return Array.from({ length: days }, (_, i) => i + 1);
            };

            const toggleConstraint = (person, day) => {
                const key = `${person}_${day}`;
                const current = constraints[key];
                const newConstraints = { ...constraints };
                if (!current) newConstraints[key] = 'X';      
                else if (current === 'X') newConstraints[key] = 'İ'; 
                else if (current === 'İ') newConstraints[key] = 'N'; 
                else delete newConstraints[key];
                setConstraints(newConstraints);
            };

            const clearConstraints = () => { setConstraints({}); setShowClearConfirm(false); };

            const calculateStats = (currentSchedule) => {
                const currentDays = loadedDate ? new Date(loadedDate.year, loadedDate.month + 1, 0).getDate() : daysInMonth;
                const newStats = {};
                staff.forEach(person => {
                    let totalHours = 0; let shifts = 0; let gapViolations = 0; let lastShiftDay = -10;
                    for (let day = 1; day <= currentDays; day++) {
                        const key = `${person}_${day}`;
                        if (currentSchedule[key] === '24') {
                            shifts++; totalHours += 24;
                            if (day - lastShiftDay === 2) gapViolations++;
                            lastShiftDay = day;
                        }
                    }
                    newStats[person] = { shifts, totalHours, gapViolations };
                });
                setStats(newStats);
            };

            const shuffleArray = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            const generateSchedule = () => {
                const targetYear = inputYear;
                const targetMonth = inputMonth;
                const targetDays = daysInMonth;
                const newSchedule = { ...constraints };
                
                let previousMonthStats = {};
                let previousMonthAvg = 0;
                let prevM = targetMonth - 1;
                let prevY = targetYear;
                if(prevM < 0) { prevM = 11; prevY -= 1; }
                const prevId = `${prevY}-${prevM}`;
                const prevProject = savedProjects.find(p => p.id === prevId);

                if (prevProject && prevProject.stats) {
                    let totalPrevShifts = 0; let countPrevStaff = 0;
                    Object.keys(prevProject.stats).forEach(p => {
                        totalPrevShifts += prevProject.stats[p].shifts;
                        countPrevStaff++;
                    });
                    if (countPrevStaff > 0) previousMonthAvg = totalPrevShifts / countPrevStaff;
                    previousMonthStats = prevProject.stats;
                }

                const nurseAvailability = {};
                let totalFixedShifts = 0;
                let standardStaffList = [];

                staff.forEach(p => {
                    let leaveCount = 0;
                    for(let d=1; d<=targetDays; d++){
                        if(constraints[`${p}_${d}`] === 'İ') leaveCount++;
                    }
                    let target = null;
                    if (leaveCount >= 10) target = 5;
                    else if (leaveCount >= 5) target = 7;
                    else if (leaveCount >= 3) target = 8;
                    
                    let historyScore = 0;
                    if (prevProject && previousMonthStats[p]) {
                        historyScore = previousMonthAvg - previousMonthStats[p].shifts;
                    }

                    if (target !== null) {
                        nurseAvailability[p] = { targetShifts: target, isFixed: true, historyScore: 0 };
                        totalFixedShifts += target;
                    } else {
                        standardStaffList.push(p);
                        nurseAvailability[p] = { isFixed: false, historyScore: historyScore };
                    }
                });

                const totalShiftsNeeded = targetDays * SHIFTS_PER_DAY;
                const remainingShiftsNeeded = Math.max(0, totalShiftsNeeded - totalFixedShifts);
                
                if (standardStaffList.length > 0) {
                    const baseTarget = Math.floor(remainingShiftsNeeded / standardStaffList.length); 
                    let remainder = remainingShiftsNeeded % standardStaffList.length; 
                    
                    standardStaffList = shuffleArray(standardStaffList); 
                    // DÜZELTME: Borcu ÇOK olan (historyScore > 0) daha fazla nöbet tutmalı.
                    // historyScore = Avg - Current. Eğer 10-8=2 ise 2 borcu var. Büyük olan öne.
                    standardStaffList.sort((a, b) => nurseAvailability[b].historyScore - nurseAvailability[a].historyScore);
                    
                    standardStaffList.forEach((p, index) => {
                        if (index < remainder) nurseAvailability[p].targetShifts = baseTarget + 1;
                        else nurseAvailability[p].targetShifts = baseTarget;
                    });
                }

                let tempSchedule = {}; 
                for (let day = 1; day <= targetDays; day++) {
                    tempSchedule[day] = [];
                    staff.forEach(person => {
                        const key = `${person}_${day}`;
                        if (constraints[key] === 'N') {
                            newSchedule[key] = '24';
                            tempSchedule[day].push(person);
                        }
                    });
                }

                let nurseState = {};
                staff.forEach(p => {
                    nurseState[p] = { shiftCount: 0, lastShiftDay: -10, gapViolations: 0 };
                    for(let d=1; d<=targetDays; d++){
                         if(newSchedule[`${p}_${d}`] === '24') {
                             nurseState[p].shiftCount++;
                             if(d - nurseState[p].lastShiftDay === 2) nurseState[p].gapViolations++;
                             nurseState[p].lastShiftDay = d;
                         }
                    }
                });

                for (let day = 1; day <= targetDays; day++) {
                    let assignedToday = [...tempSchedule[day]];
                    if (assignedToday.length >= SHIFTS_PER_DAY) continue;

                    let candidates = staff.filter(person => {
                        if (assignedToday.includes(person)) return false;
                        const constraint = constraints[`${person}_${day}`];
                        if (constraint === 'X' || constraint === 'İ') return false;
                        if (newSchedule[`${person}_${day-1}`] === '24') return false;
                        if (constraints[`${person}_${day+1}`] === 'N') return false; 
                        return true;
                    });

                    candidates = shuffleArray(candidates);

                    candidates.sort((a, b) => {
                        const stateA = nurseState[a]; const stateB = nurseState[b];
                        const infoA = nurseAvailability[a]; const infoB = nurseAvailability[b];
                        const remA = infoA.targetShifts - stateA.shiftCount;
                        const remB = infoB.targetShifts - stateB.shiftCount;
                        if (Math.abs(remA - remB) > 0.1) return remB - remA;
                        const willViolateGapA = (day - stateA.lastShiftDay === 2);
                        const willViolateGapB = (day - stateB.lastShiftDay === 2);
                        const scoreA = (willViolateGapA && stateA.gapViolations >= MAX_CONSECUTIVE_GAP_SHIFTS) ? 1000 : 0;
                        const scoreB = (willViolateGapB && stateB.gapViolations >= MAX_CONSECUTIVE_GAP_SHIFTS) ? 1000 : 0;
                        if (scoreA !== scoreB) return scoreA - scoreB;
                        return (stateA.lastShiftDay - stateB.lastShiftDay); 
                    });

                    const needed = SHIFTS_PER_DAY - assignedToday.length;
                    for (let i = 0; i < needed; i++) {
                        if (candidates[i]) {
                            const p = candidates[i];
                            newSchedule[`${p}_${day}`] = '24';
                            assignedToday.push(p);
                            nurseState[p].shiftCount++;
                            if (day - nurseState[p].lastShiftDay === 2) nurseState[p].gapViolations++;
                            nurseState[p].lastShiftDay = day;
                        }
                    }
                }

                staff.forEach(person => {
                   for (let day = 1; day <= targetDays; day++) {
                       const key = `${person}_${day}`;
                       if (constraints[key] === 'İ') newSchedule[key] = 'İ';
                   } 
                });

                setSchedule(newSchedule);
                setLoadedDate({ month: targetMonth, year: targetYear });
                saveToLocal({ staff, year: targetYear, month: targetMonth, daysInMonth: targetDays, constraints, schedule: newSchedule });
                setActiveTab('result');
            };

            const saveProject = () => {
                const saveYear = loadedDate ? loadedDate.year : inputYear;
                const saveMonth = loadedDate ? loadedDate.month : inputMonth;
                const saveDays = loadedDate ? new Date(saveYear, saveMonth + 1, 0).getDate() : daysInMonth;
                const projectData = { version: "1.0", date: new Date().toISOString(), staff, year: saveYear, month: saveMonth, daysInMonth: saveDays, constraints, schedule };
                const now = new Date();
                const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}.${String(now.getMinutes()).padStart(2, '0')}`;
                const fileName = `Cocuk Acil ${dateStr}.json`;
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", fileName);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const loadProject = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.staff) setStaff(data.staff.sort((a, b) => a.localeCompare(b, 'tr')));
                        if (data.year && data.month !== undefined) {
                            setLoadedDate({ month: data.month, year: data.year });
                            setInputMonth(data.month);
                            setInputYear(data.year);
                        }
                        if (data.daysInMonth) setDaysInMonth(data.daysInMonth);
                        if (data.constraints) setConstraints(data.constraints);
                        if (data.schedule) setSchedule(data.schedule);
                        saveToLocal(data);
                        alert("Proje başarıyla yüklendi!");
                    } catch (error) { console.error(error); alert("Dosya formatı hatalı."); }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const downloadImage = () => {
                if (tableRef.current && window.html2canvas) {
                    const originalTable = tableRef.current.querySelector('.print-container');
                    if (!originalTable) return;
                    const clone = originalTable.cloneNode(true);
                    const targetWidth = 1600; 
                    clone.style.position = 'fixed'; clone.style.top = '-10000px'; clone.style.left = '0'; clone.style.width = `${targetWidth}px`; clone.style.zIndex = '-1000'; clone.style.backgroundColor = '#ffffff'; clone.style.padding = '40px'; 
                    const originalInputs = originalTable.querySelectorAll('input');
                    const clonedInputs = clone.querySelectorAll('input');
                    originalInputs.forEach((origInput, index) => {
                        const clonedInput = clonedInputs[index];
                        if (clonedInput) {
                            const div = document.createElement('div');
                            div.innerText = origInput.value;
                            div.className = origInput.className;
                            div.style.display = 'flex'; div.style.alignItems = 'center'; div.style.justifyContent = 'center'; div.style.width = '100%'; div.style.height = '100%'; div.style.backgroundColor = 'transparent';
                            if (clonedInput.parentNode) clonedInput.parentNode.replaceChild(div, clonedInput);
                        }
                    });
                    clone.querySelectorAll('.sticky').forEach(el => { el.style.position = 'static'; });
                    document.body.appendChild(clone);
                    window.html2canvas(clone, { scale: 2, backgroundColor: "#ffffff", useCORS: true, width: targetWidth, height: clone.scrollHeight + 50 }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Cocuk_Acil_Nobet_Listesi_${loadedDate ? loadedDate.month+1 : inputMonth+1}_${loadedDate ? loadedDate.year : inputYear}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.95);
                        link.click();
                        document.body.removeChild(clone);
                    });
                }
            };

            const handleStaffUpdate = (oldName, newName) => {
                let newStaff = staff.map(s => s === oldName ? newName : s);
                // İsmi güncelledikten sonra tekrar sırala (Türkçe karakter destekli)
                newStaff.sort((a, b) => a.localeCompare(b, 'tr'));
                setStaff(newStaff);
            };

            const addStaff = () => {
                const newStaff = [...staff, "YENİ PERSONEL"];
                setStaff(newStaff); // Sıralama yapmıyoruz, kullanıcı düzenleyince sıralanır
            };
            
            const removeStaff = (nameToRemove) => {
                setStaff(staff.filter(s => s !== nameToRemove));
            };
            
            const getCellColor = (val, isWeekend) => {
                if (!val && isWeekend) return 'bg-orange-50';
                if (val === '24') return 'bg-white text-black font-extrabold'; 
                if (val === 'N') return 'bg-teal-50 text-teal-800 font-bold';
                if (val === 'X') return 'bg-gray-100 text-red-500 font-bold';
                if (val === 'İ') return 'bg-gray-50 text-gray-500 font-bold';
                return isWeekend ? 'bg-orange-50' : 'hover:bg-teal-50';
            };

            const SettingsPanel = () => (
                <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-6 animate-fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-start mb-6 gap-4 border-b border-gray-100 pb-4">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800 flex items-center"><i className="fas fa-home mr-2 text-teal-600"></i> Ana Menü</h2>
                            <p className="text-sm text-gray-500 mt-1">Nöbet programı oluşturun veya kayıtlı verileri yönetin.</p>
                        </div>
                        <div className="flex space-x-2">
                            <input type="file" accept=".json" ref={fileInputRef} style={{display:'none'}} onChange={loadProject} />
                            <button onClick={() => fileInputRef.current.click()} className="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 shadow-md flex items-center transition transform hover:scale-105"><i className="fas fa-upload mr-2"></i> Veri Yükle</button>
                            {schedule && Object.keys(schedule).length > 0 && loadedDate && (
                                <button onClick={saveProject} className="bg-orange-500 text-white py-2 px-4 rounded-lg hover:bg-orange-600 shadow-md flex items-center transition transform hover:scale-105"><i className="fas fa-save mr-2"></i> Veri Kaydet</button>
                            )}
                        </div>
                    </div>
                    {savedProjects.length > 0 && (
                        <div className="mb-8 p-6 bg-slate-50 border border-slate-200 rounded-xl shadow-inner animate-fade-in">
                            <h3 className="font-bold text-gray-700 mb-4 flex items-center"><i className="fas fa-folder-open mr-2 text-yellow-500"></i> Kayıtlı Dönemler</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                {savedProjects.map((proj) => (
                                    <div key={proj.id} className="relative group">
                                        <button onClick={() => loadFromSaved(proj)} className="w-full bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-lg hover:border-teal-400 transition text-left duration-200">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-bold text-lg text-gray-800">{MONTH_NAMES[proj.month]} {proj.year}</span>
                                                <i className="fas fa-chevron-right text-gray-400 group-hover:text-teal-500"></i>
                                            </div>
                                            <div className="text-xs text-gray-500 font-medium">
                                                <span className="inline-block bg-teal-100 text-teal-800 px-2 py-0.5 rounded mr-2">{new Date(proj.timestamp).toLocaleDateString("tr-TR")}</span>
                                                {proj.staff ? proj.staff.length : 0} Personel
                                            </div>
                                        </button>
                                        {projectToDelete !== proj.id && (
                                            <button onClick={(e) => handleDeleteClick(e, proj.id)} className="absolute top-3 right-3 bg-red-50 text-red-400 w-8 h-8 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition hover:bg-red-500 hover:text-white shadow-sm"><i className="fas fa-trash-alt text-xs"></i></button>
                                        )}
                                        {projectToDelete === proj.id && (
                                            <div className="absolute top-2 right-2 bg-white border border-gray-200 p-3 shadow-xl rounded-lg z-20 flex flex-col items-end animate-fade-in" onClick={(e) => e.stopPropagation()}>
                                                <p className="text-xs text-gray-700 font-bold mb-2 whitespace-nowrap">Silinsin mi?</p>
                                                <div className="flex gap-2">
                                                    <button onClick={cancelDeleteProject} className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200">İptal</button>
                                                    <button onClick={(e) => confirmDeleteProject(e, proj.id)} className="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Evet</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">Yıl</label>
                            <div className="relative">
                                <select value={inputYear} onChange={(e)=>setInputYear(parseInt(e.target.value))} className="block w-full appearance-none bg-white border border-gray-300 text-gray-700 py-2 px-3 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-teal-500">{YEAR_OPTIONS.map(y => (<option key={y} value={y}>{y}</option>))}</select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"><i className="fas fa-chevron-down text-xs"></i></div>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-gray-700 mb-1">Ay</label>
                            <div className="relative">
                                <select value={inputMonth} onChange={(e)=>setInputMonth(parseInt(e.target.value))} className="block w-full appearance-none bg-white border border-gray-300 text-gray-700 py-2 px-3 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-teal-500">{MONTH_NAMES.map((m,i)=>(<option key={i} value={i}>{m}</option>))}</select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"><i className="fas fa-chevron-down text-xs"></i></div>
                            </div>
                        </div>
                        <div className="flex items-end"><button onClick={() => setActiveTab('constraints')} className="w-full bg-teal-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-teal-700 transition shadow-lg transform hover:translate-y-[-1px] flex items-center justify-center"><i className="fas fa-magic mr-2"></i> Yeni Liste Oluştur</button></div>
                    </div>
                    <div className="border-t border-gray-100 pt-4">
                        <h3 className="font-bold mb-3 text-gray-700 flex items-center justify-between"><span>Personel Listesi ({staff.length} Kişi)</span><span className="text-xs text-gray-400 font-normal bg-gray-100 px-2 py-1 rounded">İsim üzerine tıklayarak düzenleyin</span></h3>
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 pr-1 custom-scroll">
                            {staff.map((p, i) => (
                                <StaffItem key={i} name={p} onSave={handleStaffUpdate} onDelete={removeStaff} />
                            ))}
                        </div>
                        <button onClick={addStaff} className="mt-4 w-full md:w-auto bg-green-50 text-green-700 py-2 px-4 rounded-lg border border-green-200 hover:bg-green-100 hover:border-green-300 transition font-bold flex items-center justify-center shadow-sm"><i className="fas fa-user-plus mr-2"></i> Personel Ekle</button>
                    </div>
                </div>
            );

            const ConstraintGrid = () => (
                <div className="bg-white p-4 rounded-xl shadow-lg mb-6 overflow-hidden animate-fade-in border border-gray-100">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-3">
                         <button onClick={() => setActiveTab('settings')} className="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 shadow flex items-center transition"><i className="fas fa-arrow-left mr-2"></i> Ana Menü</button>
                         <div className="flex flex-wrap items-center gap-3">
                            <div className="flex space-x-2 text-xs md:text-sm bg-gray-50 p-2 rounded-lg border border-gray-200"><span className="flex items-center"><span className="w-4 h-4 bg-red-100 border border-red-200 mr-1 rounded-sm"></span> X: İstemiyor</span><span className="flex items-center"><span className="w-4 h-4 bg-gray-100 border border-gray-300 mr-1 rounded-sm"></span> İ: İzinli</span><span className="flex items-center"><span className="w-4 h-4 bg-teal-50 border border-teal-300 mr-1 rounded-sm"></span> N: Kesin</span></div>
                            <div className="relative">
                                <button onClick={() => setShowClearConfirm(true)} className="bg-red-50 text-red-600 py-2 px-4 rounded-lg hover:bg-red-100 text-sm border border-red-200 flex items-center transition font-semibold"><i className="fas fa-trash-alt mr-1"></i> Temizle</button>
                                {showClearConfirm && (
                                    <div className="absolute top-full right-0 mt-2 bg-white border border-gray-200 p-4 shadow-2xl rounded-xl z-50 w-56 animate-fade-in">
                                        <p className="text-sm text-gray-800 mb-3 font-bold text-center">Tüm işaretler silinsin mi?</p>
                                        <div className="flex justify-center gap-2">
                                            <button onClick={() => setShowClearConfirm(false)} className="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg transition font-medium">Vazgeç</button>
                                            <button onClick={clearConstraints} className="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition font-bold shadow-red-200 shadow-md">Evet, Sil</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    <div className="mb-4 text-center"><h2 className="text-2xl font-bold text-gray-800">Kısıtlamalar</h2><p className="text-gray-500 text-sm font-medium">{MONTH_NAMES[inputMonth]} {inputYear}</p></div>
                    <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                        <table className="min-w-full text-xs border-collapse">
                            <thead>
                                <tr className="header-bg">
                                    <th className="th-cell sticky left-0 z-20 w-48 text-left pl-3 border border-teal-800 bg-teal-700 text-white">Personel</th>
                                    {getDaysArray().map(d => {
                                        const isWe = isWeekend(inputYear, inputMonth, d);
                                        return (
                                            <th key={d} className={`th-cell w-8 border border-teal-800 ${isWe ? 'weekend-bg text-orange-900' : 'bg-teal-700 text-white'}`}>
                                                <div className="flex flex-col"><span>{d}</span><span className="text-[9px] opacity-80">{getDayNameInitial(inputYear, inputMonth, d)}</span></div>
                                            </th>
                                        )
                                    })}
                                </tr>
                            </thead>
                            <tbody>
                                {staff.map((person, idx) => (
                                    <tr key={person} className={idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                        <td className="td-cell p-1 font-semibold sticky left-0 bg-inherit z-10 whitespace-nowrap pl-3 border-gray-300 text-gray-700">{person}</td>
                                        {getDaysArray().map(d => {
                                            const val = constraints[`${person}_${d}`];
                                            const isWe = isWeekend(inputYear, inputMonth, d);
                                            return (
                                                <td key={d} className={`td-cell cursor-pointer select-none transition-colors border-gray-300 ${getCellColor(val, isWe)}`} onClick={() => toggleConstraint(person, d)}><div className="w-full h-full flex items-center justify-center text-[10px]">{val || ''}</div></td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="mt-6 flex justify-end"><button onClick={generateSchedule} className="bg-teal-600 text-white py-3 px-8 rounded-lg font-bold hover:bg-teal-700 shadow-lg transform transition hover:scale-105 flex items-center text-lg"><i className="fas fa-magic mr-2"></i> LİSTEYİ OLUŞTUR</button></div>
                </div>
            );

            const ResultView = () => (
                <div className="animate-fade-in">
                    <style>{`.cell-input { width: 100%; height: 100%; text-align: center; background: transparent; outline: none; font-weight: inherit; } .print-container { width: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: white; }`}</style>
                    <div className="bg-white p-4 rounded-xl shadow-lg mb-6 border border-gray-100">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setActiveTab('settings')} className="bg-gray-600 text-white py-2 px-3 rounded-lg hover:bg-gray-700 text-sm shadow flex items-center transition"><i className="fas fa-home mr-2"></i> Ana Menü</button>
                                <h2 className="text-2xl font-bold text-teal-800">Nöbet Listesi</h2>
                            </div>
                            <div className="flex space-x-2">
                                <button onClick={() => setActiveTab('constraints')} className="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 text-sm shadow transition"><i className="fas fa-edit"></i> Düzenle</button>
                                <button onClick={generateSchedule} className="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 text-sm shadow transition flex items-center"><i className="fas fa-sync-alt mr-2"></i> Tekrar Dağıt</button>
                                <button onClick={downloadImage} className="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 font-bold text-sm shadow transform active:scale-95 transition"><i className="fas fa-download"></i> JPG İNDİR</button>
                            </div>
                        </div>
                        <div className="overflow-x-auto border rounded-lg bg-white shadow-inner" ref={tableRef}>
                            <div className="print-container p-8 min-w-[1200px]">
                                <div className="text-center mb-6 pb-2 border-b-2 border-teal-900">
                                    <h1 className="text-2xl font-black uppercase tracking-widest text-teal-900">ÇOCUK ACİL SERVİS NÖBET ÇİZELGESİ</h1>
                                    <h3 className="text-lg text-teal-800 uppercase mt-1 font-bold tracking-wide">{loadedDate ? MONTH_NAMES[loadedDate.month] : MONTH_NAMES[inputMonth]} {loadedDate ? loadedDate.year : inputYear}</h3>
                                </div>
                                <table className="w-full text-xs border-collapse border border-gray-800 text-black table-fixed">
                                    <thead>
                                        <tr className="header-bg">
                                            <th className="th-cell w-48 text-left pl-3 bg-teal-700 text-white uppercase border border-gray-600">PERSONEL ADI SOYADI</th>
                                            {getResultDaysArray().map(d => {
                                                const displayYear = loadedDate ? loadedDate.year : inputYear;
                                                const displayMonth = loadedDate ? loadedDate.month : inputMonth;
                                                const isWe = isWeekend(displayYear, displayMonth, d);
                                                return (
                                                    <th key={d} className={`th-cell w-8 border border-gray-600 ${isWe ? 'weekend-bg text-orange-900' : 'bg-teal-50 text-teal-900'}`}>
                                                        <div className="flex flex-col"><span>{d}</span><span className="text-[9px] font-normal opacity-80">{getDayNameInitial(displayYear, displayMonth, d)}</span></div>
                                                    </th>
                                                )
                                            })}
                                            <th className="th-cell w-10 bg-teal-100 text-teal-900 border border-gray-600">Nöbet</th>
                                            <th className="th-cell w-10 bg-teal-100 text-teal-900 border border-gray-600">Saat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {staff.map((person, idx) => {
                                            const personStats = stats[person] || {shifts:0, totalHours:0};
                                            return (
                                                <tr key={person} className={idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                                    <td className="td-cell p-1 pl-3 font-bold border border-gray-400 whitespace-nowrap text-black">{person}</td>
                                                    {getResultDaysArray().map(d => {
                                                        const displayYear = loadedDate ? loadedDate.year : inputYear;
                                                        const displayMonth = loadedDate ? loadedDate.month : inputMonth;
                                                        const isWe = isWeekend(displayYear, displayMonth, d);
                                                        const key = `${person}_${d}`;
                                                        const val = schedule[key];
                                                        let displayVal = "";
                                                        let textColor = "text-gray-300";
                                                        if (val === '24') { displayVal = "24"; textColor = "text-black font-black text-sm"; }
                                                        else if (val === 'İ') { displayVal = "İ"; textColor = "text-red-600 font-bold"; }
                                                        else if (val === 'X') { displayVal = "X"; textColor = "text-gray-400"; }
                                                        return (
                                                            <td key={d} className={`td-cell p-0 text-center relative h-8 border border-gray-400 ${isWe ? 'weekend-bg' : ''}`}>
                                                                <input className={`cell-input ${textColor}`} value={displayVal} onChange={(e) => { const newVal = e.target.value.toUpperCase(); let safeVal = newVal; if(newVal === 'I' || newVal === 'İ') safeVal = 'İ'; const newSched = {...schedule, [key]: safeVal}; setSchedule(newSched); calculateStats(newSched); if(loadedDate) { saveToLocal({ staff, year: loadedDate.year, month: loadedDate.month, daysInMonth: daysInMonth, constraints, schedule: newSched }); } }} />
                                                            </td>
                                                        );
                                                    })}
                                                    <td className="td-cell text-center font-bold bg-teal-50 text-black border border-gray-400">{personStats.shifts}</td>
                                                    <td className="td-cell text-center font-bold bg-teal-50 text-black border border-gray-400">{personStats.totalHours}</td>
                                                </tr>
                                            );
                                        })}
                                        <tr className="bg-gray-800 text-white font-bold">
                                            <td className="td-cell p-1 text-right border border-gray-600 pr-3">GÜNLÜK TOPLAM:</td>
                                            {getResultDaysArray().map(d => {
                                                let count = 0;
                                                staff.forEach(p => { if(schedule[`${p}_${d}`] === '24') count++; });
                                                return (<td key={d} className={`td-cell text-center border border-gray-600 ${count !== 6 ? 'bg-red-500 text-white' : 'bg-teal-700 text-white'}`}>{count}</td>)
                                            })}
                                            <td colSpan="2" className="td-cell border border-gray-600 bg-gray-800"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div className="flex justify-end mt-6">
                                    <div className="border-2 border-gray-800 p-3 text-xs text-black bg-white inline-block shadow-sm">
                                        <div className="font-bold border-b border-gray-800 mb-2 pb-1 text-sm text-center bg-gray-100">AÇIKLAMALAR</div>
                                        <div className="flex items-center mb-1"><span className="w-6 font-black text-center mr-2 text-black text-sm">24</span> : 24 Saat Nöbet</div>
                                        <div className="flex items-center mb-1"><span className="w-6 font-bold text-center mr-2 text-red-600">İ</span> : İzinli / Yıllık İzin</div>
                                        <div className="flex items-center mb-1"><span className="w-6 font-bold text-center mr-2 text-teal-700">N</span> : Kesin Nöbet (İstek)</div>
                                        <div className="flex items-center"><span className="w-6 font-bold text-center mr-2 text-gray-400">X</span> : Nöbet İstemiyor</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="max-w-full mx-auto p-2 md:p-6 font-sans bg-gray-50 min-h-screen">
                    <header className="flex items-center justify-center mb-6">
                        <div className="bg-teal-600 text-white p-3 rounded-full shadow-lg mr-3 transform hover:scale-110 transition"><i className="fas fa-user-nurse fa-2x"></i></div>
                        <div><h1 className="text-2xl md:text-3xl font-bold text-gray-800 tracking-tight">Nöbetmatik v1.4</h1><p className="text-gray-500 text-sm font-medium">Çocuk Acil Servis Otomasyonu</p></div>
                    </header>
                    {activeTab === 'settings' && <SettingsPanel />}
                    {activeTab === 'constraints' && <ConstraintGrid />}
                    {activeTab === 'result' && <ResultView />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


